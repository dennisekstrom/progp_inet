import java.io.IOException;
import java.net.ServerSocket;
import java.util.Scanner;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;

/**
 * @author Viebrapadata
 */
public class ATMServer {

	private static int connectionPort = 8988;
	private static volatile String defaultWelcomeMessage = "Welcome to Bank!";
	private static volatile ATMServerThread serverThread;
	private static volatile Scanner scanner = new Scanner(System.in);

	public static void main(String[] args) throws IOException {

		ServerSocket serverSocket = null;

		boolean listening = true;

		try {
			serverSocket = new ServerSocket(connectionPort);
		} catch (IOException e) {
			System.err.println("Could not listen on port: " + connectionPort);
			System.exit(1);
		}

		System.out.println("Bank started listening on port: " + connectionPort);

		serverThread = new ATMServerThread(serverSocket.accept(),
				defaultWelcomeMessage);

		ExecutorService es = Executors.newFixedThreadPool(2);
		Future<String> welcomeFuture = es.submit(getCallable());
		Future<?> threadFuture = es.submit(serverThread);

		while (listening) {
			if (welcomeFuture.isDone()) {
				try {
					serverThread.setWelcomeMessage(welcomeFuture.get());
				} catch (Exception e) {
					e.printStackTrace();
					System.exit(1);
				}
				welcomeFuture = es.submit(getCallable());
			}

			if (threadFuture.isDone())
				serverThread = new ATMServerThread(serverSocket.accept(),
						defaultWelcomeMessage);
			es.submit(serverThread);
		}

		serverSocket.close();
	}

	private static Callable<String> getCallable() {
		return new Callable<String>() {
			@Override
			public String call() {
				System.out.println(Thread.currentThread());
				return scanner.nextLine();
			}
		};
	}
}